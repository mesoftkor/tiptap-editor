{"version":3,"file":"upload.js","sources":["../../src/core/upload.ts"],"sourcesContent":["import type { UploadCategory, UploadConfig } from './types';\r\n\r\n/**\r\n * 파일명 정제 (공백을 대시로 변환, 타임스탬프 추가)\r\n */\r\nexport function sanitizeFilename(name: string): string {\r\n  const base = name.split('\\\\').pop()?.split('/').pop() || 'upload';\r\n  const ts = Date.now();\r\n  return `${base.replace(/\\s+/g, '-')}-${ts}`;\r\n}\r\n\r\n/**\r\n * File을 Data URL로 변환\r\n */\r\nexport function fileToDataUrl(file: File): Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    const reader = new FileReader();\r\n    reader.onload = () => resolve(String(reader.result));\r\n    reader.onerror = reject;\r\n    reader.readAsDataURL(file);\r\n  });\r\n}\r\n\r\n/**\r\n * S3 Presigned URL로 파일 업로드\r\n */\r\nexport async function putToPresignedUrl(\r\n  uploadUrl: string,\r\n  file: File,\r\n  headers?: Record<string, string>\r\n): Promise<Response> {\r\n  const response = await fetch(uploadUrl, {\r\n    method: 'PUT',\r\n    headers: {\r\n      'Content-Type': file.type || 'application/octet-stream',\r\n      ...(headers || {})\r\n    },\r\n    body: file\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const text = await response.text().catch(() => '');\r\n    throw new Error(`S3 업로드 실패: ${response.status} ${text}`);\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\n/**\r\n * 이미지를 S3에 업로드\r\n */\r\nexport async function uploadImageToS3(\r\n  file: File,\r\n  category: UploadCategory = 'temp',\r\n  uploadConfig?: UploadConfig\r\n): Promise<string> {\r\n  if (!uploadConfig) {\r\n    throw new Error('uploadConfig가 설정되지 않았습니다.');\r\n  }\r\n\r\n  const { uploadUrl, publicUrl, headers } = await uploadConfig.getPresignedUrl(\r\n    sanitizeFilename(file.name),\r\n    file.type || 'application/octet-stream',\r\n    category,\r\n    uploadConfig.token\r\n  );\r\n\r\n  await putToPresignedUrl(uploadUrl, file, headers);\r\n\r\n  // 커스텀 도메인 변환 함수가 있으면 사용\r\n  if (uploadConfig.convertToCustomDomain) {\r\n    return uploadConfig.convertToCustomDomain(publicUrl);\r\n  }\r\n\r\n  return publicUrl;\r\n}\r\n\r\n/**\r\n * S3에서 여러 이미지 삭제\r\n */\r\nexport async function deleteS3Images(\r\n  imageUrls: string[],\r\n  uploadConfig?: UploadConfig\r\n): Promise<{ success: boolean; deletedCount: number; message?: string }> {\r\n  if (!imageUrls || imageUrls.length === 0) {\r\n    return { success: true, deletedCount: 0 };\r\n  }\r\n\r\n  if (!uploadConfig?.deleteImages) {\r\n    console.warn('deleteImages 함수가 설정되지 않았습니다. 이미지 삭제를 건너뜁니다.');\r\n    return { success: true, deletedCount: 0 };\r\n  }\r\n\r\n  try {\r\n    return await uploadConfig.deleteImages(imageUrls, uploadConfig.token);\r\n  } catch (error) {\r\n    console.error('S3 이미지 삭제 실패:', error);\r\n    return {\r\n      success: false,\r\n      deletedCount: 0,\r\n      message: error instanceof Error ? error.message : '이미지 삭제 중 오류 발생'\r\n    };\r\n  }\r\n}\r\n"],"names":["sanitizeFilename","name","_a","base","ts","fileToDataUrl","file","resolve","reject","reader","putToPresignedUrl","uploadUrl","headers","response","text","uploadImageToS3","category","uploadConfig","publicUrl","deleteS3Images","imageUrls","error"],"mappings":"AAKO,SAASA,EAAiBC,GAAsB;AAAhD,MAAAC;AACL,QAAMC,MAAOD,IAAAD,EAAK,MAAM,IAAI,EAAE,IAAA,MAAjB,gBAAAC,EAAwB,MAAM,KAAK,UAAS,UACnDE,IAAK,KAAK,IAAA;AAChB,SAAO,GAAGD,EAAK,QAAQ,QAAQ,GAAG,CAAC,IAAIC,CAAE;AAC3C;AAKO,SAASC,EAAcC,GAA6B;AACzD,SAAO,IAAI,QAAQ,CAACC,GAASC,MAAW;AACtC,UAAMC,IAAS,IAAI,WAAA;AACnB,IAAAA,EAAO,SAAS,MAAMF,EAAQ,OAAOE,EAAO,MAAM,CAAC,GACnDA,EAAO,UAAUD,GACjBC,EAAO,cAAcH,CAAI;AAAA,EAC3B,CAAC;AACH;AAKA,eAAsBI,EACpBC,GACAL,GACAM,GACmB;AACnB,QAAMC,IAAW,MAAM,MAAMF,GAAW;AAAA,IACtC,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgBL,EAAK,QAAQ;AAAA,MAC7B,GAAIM,KAAW,CAAA;AAAA,IAAC;AAAA,IAElB,MAAMN;AAAA,EAAA,CACP;AAED,MAAI,CAACO,EAAS,IAAI;AAChB,UAAMC,IAAO,MAAMD,EAAS,OAAO,MAAM,MAAM,EAAE;AACjD,UAAM,IAAI,MAAM,cAAcA,EAAS,MAAM,IAAIC,CAAI,EAAE;AAAA,EACzD;AAEA,SAAOD;AACT;AAKA,eAAsBE,EACpBT,GACAU,IAA2B,QAC3BC,GACiB;AACjB,MAAI,CAACA;AACH,UAAM,IAAI,MAAM,2BAA2B;AAG7C,QAAM,EAAE,WAAAN,GAAW,WAAAO,GAAW,SAAAN,EAAA,IAAY,MAAMK,EAAa;AAAA,IAC3DjB,EAAiBM,EAAK,IAAI;AAAA,IAC1BA,EAAK,QAAQ;AAAA,IACbU;AAAA,IACAC,EAAa;AAAA,EAAA;AAMf,SAHA,MAAMP,EAAkBC,GAAWL,GAAMM,CAAO,GAG5CK,EAAa,wBACRA,EAAa,sBAAsBC,CAAS,IAG9CA;AACT;AAKA,eAAsBC,EACpBC,GACAH,GACuE;AACvE,MAAI,CAACG,KAAaA,EAAU,WAAW;AACrC,WAAO,EAAE,SAAS,IAAM,cAAc,EAAA;AAGxC,MAAI,EAACH,KAAA,QAAAA,EAAc;AACjB,mBAAQ,KAAK,6CAA6C,GACnD,EAAE,SAAS,IAAM,cAAc,EAAA;AAGxC,MAAI;AACF,WAAO,MAAMA,EAAa,aAAaG,GAAWH,EAAa,KAAK;AAAA,EACtE,SAASI,GAAO;AACd,mBAAQ,MAAM,iBAAiBA,CAAK,GAC7B;AAAA,MACL,SAAS;AAAA,MACT,cAAc;AAAA,MACd,SAASA,aAAiB,QAAQA,EAAM,UAAU;AAAA,IAAA;AAAA,EAEtD;AACF;"}